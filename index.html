<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VAstudy - Sua Plataforma de Estudos</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Configuração do Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#eff6ff',
              100: '#dbeafe',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              900: '#1e3a8a',
            },
            bgLight: '#F3F6FA',
            surfaceLight: '#FFFFFF',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Dependências -->
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Google API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body class="bg-bgLight text-slate-800 dark:bg-slate-900 dark:text-slate-100 font-sans overflow-hidden transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    // --- ÍCONES ---
    const Icon = ({ name, size = 24, className, ...props }) => {
      const icons = {
        play: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
        pause: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
        save: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        layoutDashboard: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>,
        timer: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>,
        checkCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
        bookOpen: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        trendingUp: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
        clock: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        plus: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        alertCircle: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
        penTool: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-7z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
        x: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        chevronLeft: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="15 18 9 12 15 6"/></svg>,
        chevronRight: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="9 18 15 12 9 6"/></svg>,
        target: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        settings: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
        uploadCloud: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>,
        downloadCloud: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>,
        moon: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
        sun: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
        refreshCw: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
        check: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="20 6 9 17 4 12"/></svg>,
        link: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
        trash2: <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      };
      return icons[name] || null;
    };

    // --- UTILS ---
    const COLORS_THEORY = '#3b82f6'; 
    const COLORS_EXERCISE = '#f59e0b'; 
    const COLORS_CORRECT = '#10b981'; 
    const COLORS_WRONG = '#ef4444'; 
    
    const formatTime = (seconds) => {
      if (!seconds) return "00:00:00";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    };

    const formatTimeShort = (seconds) => {
      if (seconds < 60) return `${seconds}s`;
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return h > 0 ? `${h}h ${m}m` : `${m}m`;
    };

    const filterSessions = (sessions, range) => {
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startOfWeek = new Date(now); startOfWeek.setDate(now.getDate() - now.getDay()); startOfWeek.setHours(0,0,0,0);
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

      return sessions.filter(s => {
        const d = new Date(s.date);
        if (range === 'today') return d >= startOfDay;
        if (range === 'week') return d >= startOfWeek;
        if (range === 'month') return d >= startOfMonth;
        return true;
      });
    };

    const CustomTimeTooltip = ({ active, payload, label }) => {
      if (active && payload && payload.length) {
        return (
          <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3 rounded-lg shadow-xl text-sm z-50">
            <p className="font-bold text-slate-900 dark:text-white mb-2">{label}</p>
            {payload.map((entry, index) => (
              <div key={index} className="flex items-center gap-2 mb-1">
                <span className="w-3 h-3 rounded-full" style={{ backgroundColor: entry.fill || entry.color }}></span>
                <span className="text-slate-600 dark:text-slate-300 capitalize">{entry.name}: </span>
                <span className="text-slate-900 dark:text-white font-mono font-bold ml-1">{formatTime(entry.value)}</span>
              </div>
            ))}
          </div>
        );
      }
      return null;
    };

    // --- WIDGETS ---
    const StatWidget = ({ icon, colorClass, title, data, type = 'number' }) => {
      const [range, setRange] = useState('total'); 
      const ranges = ['total', 'today', 'week', 'month'];
      const labels = { total: 'TOTAL', today: 'HOJE', week: 'SEMANA', month: 'MÊS' };

      const nextRange = () => setRange(ranges[(ranges.indexOf(range) + 1) % ranges.length]);
      const prevRange = () => setRange(ranges[(ranges.indexOf(range) - 1 + ranges.length) % ranges.length]);

      const filtered = filterSessions(data, range);
      let displayValue = 0;

      if (type === 'questions') {
        displayValue = filtered.reduce((acc, curr) => acc + (curr.total || 0), 0);
      } else if (type === 'accuracy') {
        const subjects = {};
        filtered.forEach(q => {
            if (!subjects[q.subject]) subjects[q.subject] = { correct: 0, total: 0 };
            subjects[q.subject].correct += (q.correct || 0);
            subjects[q.subject].total += (q.total || 0);
        });
        const subjectsKeys = Object.keys(subjects);
        if (subjectsKeys.length === 0) displayValue = 0;
        else {
            let sumPercentages = 0;
            subjectsKeys.forEach(key => {
                const s = subjects[key];
                const pct = s.total > 0 ? (s.correct / s.total) * 100 : 0;
                sumPercentages += pct;
            });
            displayValue = Math.round(sumPercentages / subjectsKeys.length);
        }
      }

      return (
        <div className="bg-surfaceLight dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-xl shadow-sm hover:shadow-md transition-all relative group flex flex-col justify-between h-full">
          <div className="flex items-center gap-4 mb-2">
            <div className={`p-3 rounded-lg ${colorClass} bg-opacity-10 dark:bg-opacity-20`}>
              <Icon name={icon} size={24} className={colorClass.replace('bg-', 'text-').replace('/10', '').replace('/20', '')} />
            </div>
            <div className="flex-1">
              <p className="text-sm text-slate-500 dark:text-slate-400 font-medium">{title}</p>
              <h3 className="text-2xl font-bold text-slate-900 dark:text-white">{displayValue}{type === 'accuracy' ? '%' : ''}</h3>
            </div>
          </div>
          <div className="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 rounded-lg p-1 mt-2 text-xs border border-slate-100 dark:border-slate-600">
            <button onClick={prevRange} className="p-1 hover:text-brand-600 text-slate-400 dark:text-slate-400 transition-colors"><Icon name="chevronLeft" size={14}/></button>
            <span className="text-slate-600 dark:text-slate-300 font-bold uppercase tracking-wide select-none w-20 text-center">{labels[range]}</span>
            <button onClick={nextRange} className="p-1 hover:text-brand-600 text-slate-400 dark:text-slate-400 transition-colors"><Icon name="chevronRight" size={14}/></button>
          </div>
        </div>
      );
    };

    const ChartWidget = ({ title, data, chartType }) => {
      const [range, setRange] = useState('total'); 
      const ranges = ['total', 'today', 'week', 'month'];
      const labels = { total: 'TOTAL', today: 'HOJE', week: 'SEMANA', month: 'MÊS' };

      const nextRange = () => setRange(ranges[(ranges.indexOf(range) + 1) % ranges.length]);
      const prevRange = () => setRange(ranges[(ranges.indexOf(range) - 1 + ranges.length) % ranges.length]);

      const filteredData = filterSessions(data, range);

      const chartData = useMemo(() => {
        if (chartType === 'subject') {
            const m = {};
            filteredData.forEach(s => {
                if (!m[s.subject]) m[s.subject] = { name: s.subject, Teoria: 0, Exercícios: 0 };
                if (s.type === 'theory') m[s.subject].Teoria += s.duration; 
                else m[s.subject].Exercícios += s.duration;
            });
            return Object.values(m);
        } else {
            const daysMap = {};
            filteredData.forEach(s => {
                const dateKey = new Date(s.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                if (!daysMap[dateKey]) daysMap[dateKey] = 0;
                daysMap[dateKey] += s.duration;
            });
            return Object.keys(daysMap).map(k => ({ name: k, Tempo: daysMap[k] }));
        }
      }, [filteredData, chartType]);

      return (
        <div className="bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 h-96 flex flex-col shadow-sm hover:shadow-md transition-all">
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-slate-900 dark:text-white font-bold flex items-center gap-2 text-lg">
                    <Icon name={chartType === 'subject' ? 'trendingUp' : 'clock'} size={20} className="text-brand-600"/>
                    {title}
                </h3>
                <div className="flex items-center bg-slate-50 dark:bg-slate-700/50 rounded-lg p-1 text-xs border border-slate-100 dark:border-slate-600">
                    <button onClick={prevRange} className="p-1 hover:text-brand-600 text-slate-400 dark:text-slate-400 transition-colors"><Icon name="chevronLeft" size={14}/></button>
                    <span className="text-slate-600 dark:text-slate-300 font-bold uppercase tracking-wide select-none w-20 text-center">{labels[range]}</span>
                    <button onClick={nextRange} className="p-1 hover:text-brand-600 text-slate-400 dark:text-slate-400 transition-colors"><Icon name="chevronRight" size={14}/></button>
                </div>
            </div>
            
            <div className="flex-1 w-full min-h-0">
                {chartData.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                        {chartType === 'subject' ? (
                            <BarChart data={chartData} layout="vertical">
                                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" className="dark:stroke-slate-700" horizontal={false} />
                                <XAxis type="number" hide />
                                <YAxis dataKey="name" type="category" stroke="#64748b" width={80} tick={{fontSize: 12, fontWeight: 500}} />
                                <Tooltip content={<CustomTimeTooltip />} cursor={{fill: '#94a3b8', opacity: 0.1}} />
                                <Legend wrapperStyle={{ paddingTop: '10px' }}/>
                                <Bar dataKey="Teoria" stackId="a" fill={COLORS_THEORY} barSize={16} radius={[0,0,0,0]} />
                                <Bar dataKey="Exercícios" stackId="a" fill={COLORS_EXERCISE} barSize={16} radius={[0,4,4,0]} />
                            </BarChart>
                        ) : (
                            <BarChart data={chartData}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" className="dark:stroke-slate-700" vertical={false} />
                                <XAxis dataKey="name" stroke="#64748b" axisLine={false} tickLine={false} tick={{fontSize: 12, fontWeight: 500}} />
                                <YAxis stroke="#64748b" axisLine={false} tickLine={false} tickFormatter={(v)=> formatTimeShort(v)} tick={{fontSize: 11}} />
                                <Tooltip content={<CustomTimeTooltip />} cursor={{fill: '#94a3b8', opacity: 0.1}} />
                                <Bar dataKey="Tempo" fill="#2563eb" radius={[4, 4, 0, 0]} barSize={24} />
                            </BarChart>
                        )}
                    </ResponsiveContainer>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-400 dark:text-slate-500">
                        <Icon name="alertCircle" size={32} className="mb-2 opacity-50"/>
                        <span className="text-sm">Sem dados neste período</span>
                    </div>
                )}
            </div>
        </div>
      );
    };

    const DashboardView = ({ studySessions, questionsLogs }) => (
      <div className="space-y-6 animate-fade-in">
        <header>
            <h2 className="text-3xl font-bold text-slate-900 dark:text-white mb-1">Dashboard</h2>
            <p className="text-slate-500 dark:text-slate-400">Visão geral da sua evolução.</p>
        </header>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div className="bg-surfaceLight dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-6 rounded-xl flex items-center gap-4 shadow-sm hover:shadow-md transition-all">
             <div className="p-3 bg-brand-50 dark:bg-brand-900/30 rounded-lg text-brand-600 dark:text-brand-400"><Icon name="clock" size={24}/></div>
             <div>
                 <p className="text-slate-500 dark:text-slate-400 text-sm font-medium">Horas Totais</p>
                 <h3 className="text-2xl font-bold text-slate-900 dark:text-white">{formatTime(studySessions.reduce((a,c)=>a+c.duration,0))}</h3>
             </div>
           </div>
           <StatWidget icon="checkCircle" colorClass="bg-purple-500 text-purple-600 dark:text-purple-400" title="Questões Feitas" data={questionsLogs} type="questions" />
           <StatWidget icon="target" colorClass="bg-green-500 text-green-600 dark:text-green-400" title="Média de Acertos" data={questionsLogs} type="accuracy" />
        </div>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <ChartWidget title="Tempo por Matéria" data={studySessions} chartType="subject" />
            <ChartWidget title="Tendência de Estudo" data={studySessions} chartType="trend" />
        </div>
      </div>
    );

    const TimerView = ({ 
        timerRunning, 
        timerSeconds, 
        currentSubject, 
        setCurrentSubject, 
        studyType, 
        setStudyType, 
        handleStartTimer, 
        handlePauseTimer, 
        handleResumeTimer,
        handleFinishSession, 
        setShowManualTimeModal 
    }) => (
        <div className="flex justify-center items-center h-full">
            <div className="bg-surfaceLight dark:bg-slate-800 p-8 rounded-3xl text-center w-full max-w-xl shadow-xl border border-slate-200 dark:border-slate-700 relative overflow-hidden transition-colors">
                <div className={`absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r transition-colors duration-500 ${studyType === 'theory' ? 'from-brand-500 to-brand-700' : 'from-amber-400 to-orange-500'}`}></div>
                
                <h2 className="text-xl mb-6 font-semibold uppercase tracking-widest text-slate-400 dark:text-slate-500">Cronômetro</h2>
                
                <div className="flex justify-center gap-4 mb-8 bg-slate-100 dark:bg-slate-900/50 p-1.5 rounded-xl w-fit mx-auto border border-slate-200 dark:border-slate-700">
                  <button onClick={() => !timerRunning && setStudyType('theory')} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all font-medium text-sm ${studyType === 'theory' ? 'bg-white dark:bg-slate-700 text-brand-600 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`} disabled={timerRunning}><Icon name="bookOpen" size={16} /> Teoria</button>
                  <button onClick={() => !timerRunning && setStudyType('exercises')} className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all font-medium text-sm ${studyType === 'exercises' ? 'bg-white dark:bg-slate-700 text-amber-600 dark:text-white shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`} disabled={timerRunning}><Icon name="penTool" size={16} /> Questões</button>
                </div>

                <div className="text-7xl md:text-8xl font-mono mb-8 font-bold tracking-tighter text-slate-800 dark:text-white transition-colors">{formatTime(timerSeconds)}</div>
                
                <div className="flex justify-center gap-4 flex-wrap">
                    {!timerRunning && timerSeconds === 0 && (
                        <button onClick={handleStartTimer} className={`flex items-center gap-2 px-8 py-4 text-white rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg shadow-brand-500/30 ${!currentSubject ? 'bg-slate-400 cursor-not-allowed' : 'bg-brand-600 hover:bg-brand-500'}`}>
                            <Icon name="play"/> Iniciar
                        </button>
                    )}

                    {timerRunning && (
                        <>
                            <button onClick={handlePauseTimer} className="bg-amber-500 hover:bg-amber-400 px-8 py-4 rounded-xl font-bold flex gap-2 text-white shadow-lg shadow-amber-500/20 transition-all transform hover:scale-105">
                                <Icon name="pause"/> Pausar
                            </button>
                            <button onClick={handleFinishSession} className="bg-brand-600 hover:bg-brand-500 px-8 py-4 rounded-xl font-bold flex gap-2 text-white shadow-lg shadow-brand-600/30 transition-all transform hover:scale-105">
                                <Icon name="save"/> Finalizar
                            </button>
                        </>
                    )}

                    {!timerRunning && timerSeconds > 0 && (
                        <>
                            <button onClick={handleResumeTimer} className="bg-emerald-600 hover:bg-emerald-500 px-8 py-4 rounded-xl font-bold flex gap-2 text-white shadow-lg shadow-emerald-600/20 transition-all transform hover:scale-105">
                                <Icon name="play"/> Retomar
                            </button>
                            <button onClick={handleFinishSession} className="bg-brand-600 hover:bg-brand-500 px-8 py-4 rounded-xl font-bold flex gap-2 text-white shadow-lg shadow-brand-600/30 transition-all transform hover:scale-105">
                                <Icon name="save"/> Salvar
                            </button>
                        </>
                    )}
                </div>
                
                <div className="mt-8 border-t border-slate-200 dark:border-slate-700 pt-6">
                    <input 
                        className="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl text-center text-slate-900 dark:text-white w-full border border-slate-200 dark:border-slate-700 focus:border-brand-500 focus:ring-1 focus:ring-brand-500 outline-none text-lg placeholder-slate-400 transition-colors font-medium" 
                        placeholder="O que você vai estudar?" 
                        list="subjects-list" 
                        value={currentSubject} 
                        onChange={e => setCurrentSubject(e.target.value)} 
                        disabled={timerRunning || (timerSeconds > 0 && !timerRunning)}
                    />
                    <button onClick={() => setShowManualTimeModal(true)} className="text-sm text-slate-500 dark:text-slate-400 mt-4 flex items-center justify-center gap-2 mx-auto hover:text-brand-600 dark:hover:text-white transition-colors font-medium">
                        <Icon name="plus" size={16}/> Entrada Manual de Tempo
                    </button>
                </div>
            </div>
        </div>
    );

    const QuestionsView = ({ newQSubject, setNewQSubject, newQTotal, setNewQTotal, newQCorrect, setNewQCorrect, handleManualAddQuestions, aggregatedQuestions }) => (
        <div className="space-y-6 animate-fade-in">
          <header className="mb-8 flex justify-between items-end"><div><h2 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">Banco de Questões</h2><p className="text-slate-500 dark:text-slate-400">Monitore sua performance.</p></div></header>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-1 bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 h-fit shadow-sm hover:shadow-md transition-all">
              <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-6">Entrada Manual</h3>
              <div className="space-y-4">
                <div><label className="block text-xs text-slate-500 dark:text-slate-400 mb-1 uppercase font-bold">Matéria</label><input list="subjects-list" type="text" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-lg p-3 focus:border-brand-500 outline-none transition-colors font-medium" placeholder="Selecione..." value={newQSubject} onChange={(e) => setNewQSubject(e.target.value)} /></div>
                <div className="grid grid-cols-2 gap-4">
                  <div><label className="block text-xs text-slate-500 dark:text-slate-400 mb-1 uppercase font-bold">Total</label><input type="number" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-lg p-3 focus:border-brand-500 outline-none transition-colors font-medium" placeholder="0" value={newQTotal} onChange={(e) => setNewQTotal(e.target.value)} /></div>
                  <div><label className="block text-xs text-slate-500 dark:text-slate-400 mb-1 uppercase font-bold">Acertos</label><input type="number" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-lg p-3 focus:border-green-500 outline-none transition-colors font-medium" placeholder="0" value={newQCorrect} onChange={(e) => setNewQCorrect(e.target.value)} /></div>
                </div>
                <button onClick={handleManualAddQuestions} className="w-full bg-brand-600 hover:bg-brand-500 text-white py-3 rounded-lg font-bold transition-colors flex justify-center items-center gap-2 shadow-lg shadow-brand-600/20"><Icon name="plus" size={18} /> Registrar</button>
              </div>
            </div>
            <div className="lg:col-span-2 bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 flex flex-col shadow-sm hover:shadow-md transition-all">
              <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2"><Icon name="checkCircle" size={20} className="text-green-500" /> Performance por Matéria</h3>
              {aggregatedQuestions.length > 0 ? (
                <div className="flex-1 w-full h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={aggregatedQuestions} layout="vertical" stackOffset="expand">
                      <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" className="dark:stroke-slate-700" horizontal={false}/>
                      <XAxis type="number" hide />
                      <YAxis dataKey="subject" type="category" stroke="#64748b" width={80} tick={{fontSize: 12, fontWeight: 500}} />
                      <Tooltip cursor={{fill: '#94a3b8', opacity: 0.1}} content={({ active, payload, label }) => {
                        if (active && payload && payload.length) {
                          const data = payload[0].payload;
                          return <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3 rounded-lg shadow-xl text-sm z-50"><p className="font-bold text-slate-900 dark:text-white mb-2">{label}</p><p className="text-green-600 dark:text-green-400">Acertos: {data.correct} ({data.correctPct}%)</p><p className="text-red-600 dark:text-red-400">Erros: {data.wrong} ({data.wrongPct}%)</p><p className="text-slate-500 text-xs mt-1">Total: {data.total}</p></div>;
                        } return null;
                      }} />
                      <Bar dataKey="correctPct" name="Acertos" fill={COLORS_CORRECT} stackId="a" barSize={20} />
                      <Bar dataKey="wrongPct" name="Erros" fill={COLORS_WRONG} stackId="a" barSize={20} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              ) : <div className="flex flex-col items-center justify-center h-64 text-slate-400 dark:text-slate-500"><Icon name="trendingUp" size={32} className="mb-2 opacity-50"/>Sem dados.</div>}
            </div>
          </div>
        </div>
    );

    const SettingsView = ({ theme, toggleTheme, exportData, importData, driveConfig, setDriveConfig, isDriveAuthenticated, handleDriveLogin, syncStatus, openDeleteModal }) => (
        <div className="space-y-8 animate-fade-in max-w-3xl mx-auto">
          <header><h2 className="text-3xl font-bold text-slate-900 dark:text-white mb-2">Configurações</h2><p className="text-slate-500 dark:text-slate-400">Personalize sua experiência.</p></header>
          
          <div className="bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
             <div className="flex items-center gap-3">
                <div className="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-600 dark:text-white"><Icon name={theme === 'dark' ? 'moon' : 'sun'} size={20}/></div>
                <div><h3 className="text-lg font-bold text-slate-900 dark:text-white">Aparência</h3><p className="text-sm text-slate-500">Alternar entre modo claro e escuro.</p></div>
             </div>
             <button onClick={toggleTheme} className="bg-slate-200 dark:bg-slate-600 relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none">
                <span className={`pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${theme === 'dark' ? 'translate-x-5' : 'translate-x-0'}`}></span>
             </button>
          </div>

          <div className="bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2"><Icon name="save" size={20}/> Backup Manual</h3>
            <p className="text-slate-500 dark:text-slate-400 mb-4 text-sm">Salve seus dados localmente.</p>
            <div className="flex gap-4">
              <button onClick={exportData} className="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded-lg font-bold flex gap-2 transition-colors"><Icon name="downloadCloud" size={20}/> Baixar Backup</button>
              <label className="bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-900 dark:text-white px-4 py-2 rounded-lg font-bold flex gap-2 cursor-pointer transition-colors border border-slate-200 dark:border-slate-600">
                <Icon name="uploadCloud" size={20}/> Restaurar Arquivo <input type="file" accept=".json" className="hidden" onChange={importData}/>
              </label>
            </div>
          </div>

          <div className="bg-surfaceLight dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
            <h3 className="text-xl font-bold text-slate-900 dark:text-white mb-4 flex items-center gap-2 text-green-600 dark:text-green-400"><Icon name="uploadCloud" size={20}/> Google Drive Sync (Auto-Save)</h3>
            <div className="bg-yellow-50 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-200 p-4 rounded-lg mb-6 text-sm border border-yellow-200 dark:border-yellow-800">
              <strong>Nota:</strong> O login do Google expira em 1 hora. Se isso acontecer, o app tentará renovar automaticamente quando você salvar.
            </div>
            
            <div className="space-y-4 mb-6">
               <div><label className="text-xs font-bold text-slate-500 uppercase">Google Client ID</label><input type="text" value={driveConfig.clientId} onChange={e=>setDriveConfig({...driveConfig, clientId:e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded p-2 text-slate-900 dark:text-white outline-none focus:border-brand-500 font-mono text-sm" placeholder="ex: 123...apps.googleusercontent.com"/></div>
               <div><label className="text-xs font-bold text-slate-500 uppercase">Google API Key</label><input type="text" value={driveConfig.apiKey} onChange={e=>setDriveConfig({...driveConfig, apiKey:e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded p-2 text-slate-900 dark:text-white outline-none focus:border-brand-500 font-mono text-sm" placeholder="ex: AIzaSy..."/></div>
            </div>

            <div className="flex flex-wrap gap-4 items-center justify-between">
               <div className="flex items-center gap-4">
                   {!isDriveAuthenticated ? (
                     <button onClick={handleDriveLogin} className="bg-white border border-slate-300 text-slate-700 px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-slate-50 transition-colors"><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" className="w-5 h-5"/> Conectar</button>
                   ) : (
                     <span className="text-green-600 dark:text-green-400 font-bold flex items-center gap-2"><Icon name="checkCircle" size={18}/> Conectado</span>
                   )}
               </div>
               <div className="flex items-center gap-2 text-sm font-medium">
                    <span>Status:</span>
                    <span className={`${syncStatus === 'saved' ? 'text-green-500' : syncStatus === 'saving' ? 'text-brand-500 animate-pulse' : syncStatus === 'error' ? 'text-red-500' : 'text-slate-400'}`}>
                        {syncStatus === 'saved' ? 'Salvo na Nuvem' : syncStatus === 'saving' ? 'Salvando...' : syncStatus === 'error' ? 'Erro ao Salvar' : 'Aguardando...'}
                    </span>
               </div>
            </div>
          </div>

          {/* Zona de Perigo */}
          <div className="bg-red-50 dark:bg-red-900/10 p-6 rounded-xl border border-red-200 dark:border-red-800 shadow-sm">
            <h3 className="text-xl font-bold text-red-700 dark:text-red-400 mb-4 flex items-center gap-2"><Icon name="alertCircle" size={20}/> Zona de Perigo</h3>
            <p className="text-red-600 dark:text-red-300 mb-4 text-sm">Esta ação apagará todos os seus dados de estudo e questões localmente. A configuração do Drive será mantida.</p>
            <button onClick={openDeleteModal} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold flex gap-2 transition-colors shadow-lg shadow-red-600/20"><Icon name="trash2" size={20}/> Resetar Todos os Dados</button>
          </div>
        </div>
    );

    const App = () => {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [timerRunning, setTimerRunning] = useState(false);
      const [timerSeconds, setTimerSeconds] = useState(0);
      const [currentSubject, setCurrentSubject] = useState('');
      const [studyType, setStudyType] = useState('theory');
      
      // Theme State
      const [theme, setTheme] = useState(() => localStorage.getItem('vastudy_theme') || 'light');

      const [showPostSessionModal, setShowPostSessionModal] = useState(false);
      const [showManualTimeModal, setShowManualTimeModal] = useState(false);
      const [postSessionQuestions, setPostSessionQuestions] = useState({ total: '', correct: '' });
      const [tempSessionData, setTempSessionData] = useState(null);

      // DELETE MODAL STATE
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [deleteInput, setDeleteInput] = useState('');

      // DADOS
      const [studySessions, setStudySessions] = useState(() => JSON.parse(localStorage.getItem('studyHub_sessions')) || []);
      const [questionsLogs, setQuestionsLogs] = useState(() => JSON.parse(localStorage.getItem('studyHub_questions_logs')) || []);
      const [savedSubjects, setSavedSubjects] = useState(() => JSON.parse(localStorage.getItem('studyHub_subjects')) || []);

      // DRIVE
      const [driveConfig, setDriveConfig] = useState(() => JSON.parse(localStorage.getItem('studyHub_driveConfig')) || { clientId: '', apiKey: '' });
      const [isDriveAuthenticated, setIsDriveAuthenticated] = useState(false);
      const [tokenClient, setTokenClient] = useState(null);
      const [syncStatus, setSyncStatus] = useState('idle'); // idle, saving, saved, error
      
      // Refs para controlar promessas de token
      const folderIdRef = useRef(null);
      const tokenPromiseResolver = useRef(null);

      const [newQSubject, setNewQSubject] = useState('');
      const [newQTotal, setNewQTotal] = useState('');
      const [newQCorrect, setNewQCorrect] = useState('');
      const [manualTime, setManualTime] = useState({ hours: '', minutes: '', subject: '', type: 'theory' });

      // THEME EFFECT
      useEffect(() => {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('vastudy_theme', theme);
      }, [theme]);

      const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

      // PERSISTÊNCIA LOCAL
      useEffect(() => localStorage.setItem('studyHub_sessions', JSON.stringify(studySessions)), [studySessions]);
      useEffect(() => localStorage.setItem('studyHub_questions_logs', JSON.stringify(questionsLogs)), [questionsLogs]);
      useEffect(() => localStorage.setItem('studyHub_subjects', JSON.stringify(savedSubjects)), [savedSubjects]);
      useEffect(() => localStorage.setItem('studyHub_driveConfig', JSON.stringify(driveConfig)), [driveConfig]);

      // GOOGLE DRIVE SETUP
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/drive.file';
      const BACKUP_FOLDER_NAME = 'VAstudy Backup';
      const BACKUP_FILE_NAME = 'vastudy_backup.json';

      useEffect(() => {
        if(driveConfig.clientId && driveConfig.apiKey && typeof gapi !== 'undefined' && typeof google !== 'undefined') {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: driveConfig.apiKey, discoveryDocs: [DISCOVERY_DOC] });
                
                // TENTATIVA DE RESTAURAR SESSÃO
                const savedTokenString = localStorage.getItem('vastudy_google_token');
                if (savedTokenString) {
                    try {
                        const savedToken = JSON.parse(savedTokenString);
                        // Se existe token, assumimos autenticado visualmente, mesmo que expirado
                        // A validade será checada no momento do uso (save)
                        gapi.client.setToken(savedToken);
                        setIsDriveAuthenticated(true);
                        console.log("Sessão restaurada (validade será checada no uso).");
                    } catch (e) {
                        console.error("Erro token:", e);
                    }
                }
            });
            
            const client = google.accounts.oauth2.initTokenClient({
              client_id: driveConfig.clientId,
              scope: SCOPES,
              callback: (r) => { 
                  if (r.access_token) {
                      const expiresIn = r.expires_in || 3599;
                      const expiryTime = Date.now() + (expiresIn * 1000);
                      const tokenObj = { ...r, expiry: expiryTime };
                      
                      localStorage.setItem('vastudy_google_token', JSON.stringify(tokenObj));
                      setIsDriveAuthenticated(true); 
                      
                      // Se havia uma promessa pendente esperando login, resolve ela
                      if (tokenPromiseResolver.current) {
                          tokenPromiseResolver.current(tokenObj);
                          tokenPromiseResolver.current = null;
                      }
                  }
              },
            });
            setTokenClient(client);
        }
      }, [driveConfig]);

      const handleDriveLogin = () => {
          if (tokenClient) {
              // Se for chamado manualmente, pode ser para renovar
              tokenClient.requestAccessToken({prompt: ''});
          }
      };

      // --- AUTH GUARD ---
      const ensureAuth = async () => {
          const savedTokenString = localStorage.getItem('vastudy_google_token');
          if (!savedTokenString) {
              // Sem token nenhum -> Login forçado
              return new Promise((resolve) => {
                  tokenPromiseResolver.current = resolve;
                  tokenClient.requestAccessToken({prompt: ''});
              });
          }

          const savedToken = JSON.parse(savedTokenString);
          // Margem de segurança de 60s
          if (Date.now() > (savedToken.expiry - 60000)) {
              console.log("Token expirado. Renovando...");
              return new Promise((resolve) => {
                  tokenPromiseResolver.current = resolve;
                  // Trigger popup. Como isso será chamado dentro de um evento de click (Save), o popup abre.
                  tokenClient.requestAccessToken({prompt: ''});
              });
          }

          return savedToken;
      };

      // --- FOLDER LOGIC ---
      const getOrCreateBackupFolder = async () => {
          if (folderIdRef.current) return folderIdRef.current;
          try {
              const q = `mimeType = 'application/vnd.google-apps.folder' and name = '${BACKUP_FOLDER_NAME}' and trashed = false`;
              const res = await gapi.client.drive.files.list({ q, fields: 'files(id)' });
              if (res.result.files.length > 0) {
                  folderIdRef.current = res.result.files[0].id;
                  return res.result.files[0].id;
              } else {
                  const meta = { name: BACKUP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' };
                  const createRes = await gapi.client.drive.files.create({ resource: meta, fields: 'id' });
                  folderIdRef.current = createRes.result.id;
                  return createRes.result.id;
              }
          } catch (e) {
              console.error("Erro pasta:", e);
              throw e;
          }
      };

      const saveToDrive = useCallback(async (silent = false) => {
        if (!isDriveAuthenticated) {
            if (!silent) alert("Conecte-se ao Google Drive nas configurações primeiro.");
            return;
        }
        
        setSyncStatus('saving');

        try {
            // GARANTIA DE LOGIN (Renova se expirado)
            await ensureAuth();

            const data = { studySessions, questionsLogs, savedSubjects, theme, backupDate: new Date().toISOString() };
            const fileContent = JSON.stringify(data);
            const file = new Blob([fileContent], {type: 'application/json'});

            const folderId = await getOrCreateBackupFolder();
            
            const q = `name = '${BACKUP_FILE_NAME}' and '${folderId}' in parents and trashed = false`;
            const res = await gapi.client.drive.files.list({ q, fields: 'files(id)'});
            const existing = res.result.files[0];

            const metadata = { name: BACKUP_FILE_NAME, mimeType: 'application/json' };
            if (!existing) metadata.parents = [folderId]; 

            const accessToken = gapi.client.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            const url = existing 
                ? `https://www.googleapis.com/upload/drive/v3/files/${existing.id}?uploadType=multipart`
                : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
            
            const method = existing ? 'PATCH' : 'POST';

            await fetch(url, { method, headers: {'Authorization': 'Bearer ' + accessToken}, body: form });
            
            setSyncStatus('saved');
            if (!silent) console.log("Auto-save concluído.");
        } catch(e) { 
            console.error(e); 
            setSyncStatus('error');
            if (!silent) alert("Erro no upload: " + e.message); 
        }
      }, [isDriveAuthenticated, studySessions, questionsLogs, savedSubjects, theme]);

      // AUTO-SAVE EFFECT
      useEffect(() => {
        if (!isDriveAuthenticated) return;
        
        const timeoutId = setTimeout(() => {
            // Auto-save só tenta se achar que o token é válido para evitar popup aleatório
            // Se estiver expirado, ele vai falhar silenciosamente ou podemos forçar o check no próximo click manual
            // A melhor UX é: auto-save tenta. Se der erro de auth, muda status pra 'Erro' mas não abre popup na cara do usuário.
            // O popup só abre em interação manual.
            const savedTokenString = localStorage.getItem('vastudy_google_token');
            if (savedTokenString) {
                const t = JSON.parse(savedTokenString);
                if (Date.now() < (t.expiry - 60000)) {
                   saveToDrive(true);
                } else {
                    setSyncStatus('error'); // Indica que precisa de atenção
                }
            }
        }, 2000); 

        return () => clearTimeout(timeoutId);
      }, [studySessions, questionsLogs, savedSubjects, theme, isDriveAuthenticated]); // Removido saveToDrive da dependência para evitar loop


      const syncDownloadFromDrive = async () => {
          if (!isDriveAuthenticated) return alert("Login necessário");
          try {
              await ensureAuth(); // Garante token válido antes de baixar
              const folderId = await getOrCreateBackupFolder();
              const q = `name = '${BACKUP_FILE_NAME}' and '${folderId}' in parents and trashed = false`;
              const res = await gapi.client.drive.files.list({ q, fields: 'files(id)'});
              
              if (res.result.files.length > 0) {
                  const f = await gapi.client.drive.files.get({ fileId: res.result.files[0].id, alt: 'media' });
                  const d = f.result;
                  if (confirm("Substituir dados locais pelos da nuvem?")) {
                      setStudySessions(d.studySessions || []); 
                      setQuestionsLogs(d.questionsLogs || []); 
                      setSavedSubjects(d.savedSubjects || []);
                      if(d.theme) setTheme(d.theme);
                      alert("Dados carregados com sucesso!");
                  }
              } else alert("Nenhum backup encontrado na pasta VAstudy Backup.");
          } catch(e) { console.error(e); alert("Erro no download: " + e.message); }
      };

      const exportData = () => {
          const blob = new Blob([JSON.stringify({studySessions, questionsLogs, savedSubjects, theme}, null, 2)], {type: 'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'vastudy_backup.json'; a.click();
      };
      const importData = (e) => {
          const r = new FileReader(); r.onload = (ev) => {
              const d = JSON.parse(ev.target.result);
              if(confirm("Substituir dados?")) { 
                  setStudySessions(d.studySessions||[]); setQuestionsLogs(d.questionsLogs||[]); setSavedSubjects(d.savedSubjects||[]); 
                  if(d.theme) setTheme(d.theme);
              }
          };
          if(e.target.files[0]) r.readAsText(e.target.files[0]);
      };

      const registerSubject = (n) => {
        const c = n.trim(); if(c && !savedSubjects.includes(c)) setSavedSubjects(p => [...p, c].sort());
      };

      useEffect(() => {
        let i; if(timerRunning) i = setInterval(() => setTimerSeconds(p => p + 1), 1000);
        return () => clearInterval(i);
      }, [timerRunning]);

      const handleFinishSession = () => {
         if (timerRunning) setTimerRunning(false);
         
         if(!currentSubject) return alert("Informe a matéria");
         if (timerSeconds < 10 && !window.confirm("Tempo curto (<10s). Salvar mesmo assim?")) return;

         const session = { id: Date.now(), subject: currentSubject, duration: timerSeconds, date: new Date().toISOString(), type: studyType };
         
         if (studyType === 'exercises') { 
             setTempSessionData(session); 
             setShowPostSessionModal(true); 
         } else { 
             setStudySessions(p => [...p, session]); 
             registerSubject(currentSubject); 
             setTimerSeconds(0); 
             // O useEffect de auto-save vai pegar essa mudança
             // Se o token estiver vencido, o status muda para erro, e no próximo clique manual o usuário renova
             alert("Sessão de Teoria Salva!"); 
         }
      };

      const handleStartTimer = () => {
        if (!currentSubject) return alert("Digite a matéria");
        registerSubject(currentSubject);
        setTimerRunning(true);
      };

      const handlePauseTimer = () => {
        setTimerRunning(false);
      };

      const handleResumeTimer = () => {
        setTimerRunning(true);
      };

      const handleManualTimeSubmit = () => {
         const s = (parseInt(manualTime.hours)||0)*3600 + (parseInt(manualTime.minutes)||0)*60;
         if(s===0 || !manualTime.subject) return alert("Dados inválidos");
         setStudySessions(p => [...p, { id: Date.now(), subject: manualTime.subject, duration: s, date: new Date().toISOString(), type: manualTime.type }]);
         registerSubject(manualTime.subject);
         setShowManualTimeModal(false);
         alert("Salvo!");
      };
      
      const handlePostSessionSubmit = () => {
        const t = parseInt(postSessionQuestions.total); const c = parseInt(postSessionQuestions.correct);
        if (isNaN(t) || isNaN(c) || c > t) return alert("Dados inválidos");
        
        setStudySessions(p => [...p, tempSessionData]);
        registerSubject(tempSessionData.subject);
        setQuestionsLogs(p => [...p, { id: Date.now(), date: new Date().toISOString(), subject: tempSessionData.subject, total: t, correct: c, wrong: t-c }]);

        setTimerSeconds(0);
        setCurrentSubject('');
        setStudyType('theory');
        setTempSessionData(null);
        setShowPostSessionModal(false);
        setPostSessionQuestions({ total: '', correct: '' });
      };

      const handleManualAddQuestions = () => {
        const t = parseInt(newQTotal); const c = parseInt(newQCorrect);
        if (!newQSubject || isNaN(t) || isNaN(c) || c > t) return alert("Dados inválidos");
        registerSubject(newQSubject);
        setQuestionsLogs(p => [...p, { id: Date.now(), date: new Date().toISOString(), subject: newQSubject, total: t, correct: c, wrong: t-c }]);
        setNewQSubject(''); setNewQTotal(''); setNewQCorrect('');
        alert("Registrado!");
      };

      const aggregatedQuestions = useMemo(() => {
        const agg = {};
        questionsLogs.forEach(l => {
            if (!agg[l.subject]) agg[l.subject] = { subject: l.subject, total: 0, correct: 0, wrong: 0 };
            agg[l.subject].total += l.total; agg[l.subject].correct += l.correct; agg[l.subject].wrong += l.wrong;
        });
        return Object.values(agg).map(q => ({...q, correctPct: q.total>0?Math.round((q.correct/q.total)*100):0, wrongPct: q.total>0?Math.round((q.wrong/q.total)*100):0 }));
      }, [questionsLogs]);

      // DELETE CONFIRMATION LOGIC
      const openDeleteModal = () => {
        setDeleteInput('');
        setShowDeleteModal(true);
      };

      const confirmDelete = () => {
        if (deleteInput === 'DELETE') {
            setStudySessions([]);
            setQuestionsLogs([]);
            setSavedSubjects([]);
            setShowDeleteModal(false);
            alert("Todos os dados de estudo foram apagados com sucesso.");
        }
      };

      return (
        <div className="flex h-screen bg-bgLight dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans overflow-hidden relative transition-colors duration-300">
            <datalist id="subjects-list">{savedSubjects.map((s,i)=><option key={i} value={s}/>)}</datalist>
            
            {/* DELETE MODAL */}
            {showDeleteModal && (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-fade-in">
                    <div className="bg-surfaceLight dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-2xl w-full max-w-md relative transition-colors">
                        <button onClick={() => setShowDeleteModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-900 dark:hover:text-white"><Icon name="x" size={24} /></button>
                        <h3 className="text-2xl font-bold text-red-600 dark:text-red-500 mb-2 flex items-center gap-2"><Icon name="alertCircle"/> Zona de Perigo</h3>
                        <p className="text-slate-500 dark:text-slate-400 mb-6">Esta ação é irreversível. Para confirmar a exclusão de TODOS os dados de estudo (mantendo apenas o login), digite <strong>DELETE</strong> abaixo:</p>
                        <input 
                            type="text" 
                            className="w-full bg-slate-50 dark:bg-slate-900 border border-red-200 dark:border-red-900/50 text-slate-900 dark:text-white rounded-lg p-3 focus:border-red-500 outline-none transition-colors font-medium mb-4" 
                            value={deleteInput} 
                            onChange={(e) => setDeleteInput(e.target.value)}
                            placeholder="DELETE"
                        />
                        <button 
                            onClick={confirmDelete} 
                            disabled={deleteInput !== 'DELETE'}
                            className={`w-full py-3 rounded-lg font-bold shadow-lg transition-all ${deleteInput === 'DELETE' ? 'bg-red-600 hover:bg-red-500 text-white shadow-red-600/20' : 'bg-slate-200 dark:bg-slate-700 text-slate-400 cursor-not-allowed'}`}
                        >
                            Apagar Tudo
                        </button>
                    </div>
                </div>
            )}
            
            {showPostSessionModal && (
              <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4 animate-fade-in">
                <div className="bg-surfaceLight dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-2xl w-full max-w-md relative transition-colors">
                  <button onClick={() => setShowPostSessionModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-900 dark:hover:text-white"><Icon name="x" size={24} /></button>
                  <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-2">Sessão Finalizada!</h3>
                  <p className="text-slate-500 dark:text-slate-400 mb-6">Estudou <span className="font-semibold text-brand-600 dark:text-brand-400">{tempSessionData?.subject}</span> por {formatTime(tempSessionData?.duration)}.</p>
                  <div className="space-y-4">
                    <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Total de Questões</label><input type="number" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-lg p-3 focus:border-amber-500 outline-none transition-colors font-medium" value={postSessionQuestions.total} onChange={(e) => setPostSessionQuestions({...postSessionQuestions, total: e.target.value})} /></div>
                    <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1 uppercase">Acertos</label><input type="number" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-lg p-3 focus:border-green-500 outline-none transition-colors font-medium" value={postSessionQuestions.correct} onChange={(e) => setPostSessionQuestions({...postSessionQuestions, correct: e.target.value})} /></div>
                    <div className="pt-2"><button onClick={handlePostSessionSubmit} className="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-green-600/20">Salvar Tudo</button></div>
                  </div>
                </div>
              </div>
            )}

            {showManualTimeModal && (
             <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-[100] p-4"><div className="bg-surfaceLight dark:bg-slate-800 p-8 rounded-2xl w-full max-w-md relative border border-slate-200 dark:border-slate-700 transition-colors"><button onClick={()=>setShowManualTimeModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-900 dark:hover:text-white"><Icon name="x"/></button><h3 className="text-xl font-bold mb-4 text-slate-900 dark:text-white">Manual Time</h3><input className="w-full bg-slate-50 dark:bg-slate-900 p-3 rounded mb-3 text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 outline-none focus:border-brand-500 font-medium" placeholder="Matéria" list="subjects-list" value={manualTime.subject} onChange={e=>setManualTime({...manualTime, subject:e.target.value})} /><div className="flex gap-2 mb-3"><input type="number" className="w-1/2 bg-slate-50 dark:bg-slate-900 p-3 rounded text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 outline-none focus:border-brand-500 font-medium" placeholder="Horas" value={manualTime.hours} onChange={e=>setManualTime({...manualTime, hours:e.target.value})} /><input type="number" className="w-1/2 bg-slate-50 dark:bg-slate-900 p-3 rounded text-slate-900 dark:text-white border border-slate-200 dark:border-slate-700 outline-none focus:border-brand-500 font-medium" placeholder="Min" value={manualTime.minutes} onChange={e=>setManualTime({...manualTime, minutes:e.target.value})} /></div><div className="mb-4"><label className="block text-xs font-bold mb-2 text-slate-500 dark:text-slate-400">Tipo</label><div className="flex gap-2"><button onClick={()=>setManualTime({...manualTime, type:'theory'})} className={`flex-1 py-2 rounded font-medium text-sm transition-colors ${manualTime.type==='theory'?'bg-brand-600 text-white':'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400'}`}>Teoria</button><button onClick={()=>setManualTime({...manualTime, type:'exercises'})} className={`flex-1 py-2 rounded font-medium text-sm transition-colors ${manualTime.type==='exercises'?'bg-amber-500 text-white':'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400'}`}>Questões</button></div></div><button onClick={handleManualTimeSubmit} className="w-full bg-brand-600 hover:bg-brand-500 py-3 rounded font-bold text-white shadow-lg shadow-brand-600/20">Salvar</button></div></div>
            )}

            <aside className="w-20 md:w-64 bg-surfaceLight dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col z-10 transition-colors duration-300">
              <div className="p-6 flex items-center justify-center md:justify-start gap-3 h-20 border-b border-slate-100 dark:border-slate-800">
                <div className="w-10 h-10 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-brand-500/20">V</div>
                <h1 className="hidden md:block text-xl font-bold text-slate-800 dark:text-white tracking-tight">VAstudy</h1>
              </div>
              <nav className="flex-1 p-4 space-y-2">
                <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex items-center gap-3 p-4 rounded-lg font-medium transition-all ${activeTab==='dashboard'?'bg-brand-50 dark:bg-slate-800 text-brand-600 dark:text-brand-400 shadow-sm border-l-4 border-brand-600':'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-slate-200 border-l-4 border-transparent'}`}><Icon name="layoutDashboard"/><span className="hidden md:block">Dashboard</span></button>
                <button onClick={()=>setActiveTab('timer')} className={`w-full flex items-center gap-3 p-4 rounded-lg font-medium transition-all ${activeTab==='timer'?'bg-brand-50 dark:bg-slate-800 text-brand-600 dark:text-brand-400 shadow-sm border-l-4 border-brand-600':'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-slate-200 border-l-4 border-transparent'}`}><Icon name="timer"/><span className="hidden md:block">Cronômetro</span></button>
                <button onClick={()=>setActiveTab('questions')} className={`w-full flex items-center gap-3 p-4 rounded-lg font-medium transition-all ${activeTab==='questions'?'bg-brand-50 dark:bg-slate-800 text-brand-600 dark:text-brand-400 shadow-sm border-l-4 border-brand-600':'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-slate-200 border-l-4 border-transparent'}`}><Icon name="checkCircle"/><span className="hidden md:block">Questões</span></button>
                <div className="pt-4 mt-4 border-t border-slate-100 dark:border-slate-800">
                  <button onClick={()=>setActiveTab('settings')} className={`w-full flex items-center gap-3 p-4 rounded-lg font-medium transition-all ${activeTab==='settings'?'bg-brand-50 dark:bg-slate-800 text-brand-600 dark:text-brand-400 shadow-sm border-l-4 border-brand-600':'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:hover:text-slate-200 border-l-4 border-transparent'}`}><Icon name="settings"/><span className="hidden md:block">Configurações</span></button>
                </div>
              </nav>
              <div className="p-4 flex justify-between items-center md:justify-between gap-2 text-xs text-slate-400 dark:text-slate-600 font-medium border-t border-slate-100 dark:border-slate-800">
                <span>v2.3.0</span>
                {syncStatus !== 'idle' && (
                    <span className={`flex items-center gap-1 ${syncStatus === 'saved' ? 'text-green-500' : syncStatus === 'saving' ? 'text-brand-500' : 'text-red-500'}`}>
                        {syncStatus === 'saving' && <Icon name="refreshCw" size={12} className="animate-spin"/>}
                        {syncStatus === 'saved' && <Icon name="check" size={12}/>}
                        {syncStatus === 'error' && <Icon name="alertCircle" size={12}/>}
                        <span className="hidden md:inline">{syncStatus === 'saved' ? 'Salvo' : syncStatus === 'saving' ? 'Sync' : 'Erro'}</span>
                    </span>
                )}
              </div>
            </aside>
            <main className="flex-1 overflow-y-auto p-4 md:p-8 transition-colors duration-300">
               {activeTab === 'dashboard' && <DashboardView studySessions={studySessions} questionsLogs={questionsLogs} />}
               {activeTab === 'timer' && <TimerView timerRunning={timerRunning} timerSeconds={timerSeconds} currentSubject={currentSubject} setCurrentSubject={setCurrentSubject} studyType={studyType} setStudyType={setStudyType} handleStartTimer={handleStartTimer} handlePauseTimer={handlePauseTimer} handleResumeTimer={handleResumeTimer} handleFinishSession={handleFinishSession} setShowManualTimeModal={setShowManualTimeModal} />}
               {activeTab === 'questions' && <QuestionsView newQSubject={newQSubject} setNewQSubject={setNewQSubject} newQTotal={newQTotal} setNewQTotal={setNewQTotal} newQCorrect={newQCorrect} setNewQCorrect={setNewQCorrect} handleManualAddQuestions={handleManualAddQuestions} aggregatedQuestions={aggregatedQuestions} />}
               {activeTab === 'settings' && <SettingsView theme={theme} toggleTheme={toggleTheme} exportData={exportData} importData={importData} driveConfig={driveConfig} setDriveConfig={setDriveConfig} isDriveAuthenticated={isDriveAuthenticated} handleDriveLogin={handleDriveLogin} syncUploadToDrive={() => saveToDrive(false)} syncDownloadFromDrive={syncDownloadFromDrive} syncStatus={syncStatus} openDeleteModal={openDeleteModal} />}
            </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
